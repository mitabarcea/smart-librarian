<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Librarian</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
   const tok = localStorage.getItem('access');
   if(!tok){ window.location.href = 'login.html'; }
  </script>
  <button onclick="localStorage.removeItem('access'); location.href='login.html'">Logout</button>
  <script>
    // Enable class-based dark mode so toggling the `dark` class works
    tailwind.config = { darkMode: 'class' };
  </script>
  <style>
    /* subtle scrollbar */
    .nice-scroll::-webkit-scrollbar{height:10px;width:10px}
    .nice-scroll::-webkit-scrollbar-thumb{background:#d4d4d8;border-radius:8px}
    .dark .nice-scroll::-webkit-scrollbar-thumb{background:#3f3f46}
  </style>
</head>
<body class="h-full bg-gradient-to-b from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-950 text-slate-900 dark:text-slate-100">
  <div class="min-h-full max-w-4xl mx-auto px-4 py-6">
    <!-- Header -->
    <header class="flex items-center justify-between mb-4">
      <div>
        <h1 class="text-3xl font-bold tracking-tight">Smart Librarian</h1>
        <p class="text-sm text-slate-500 dark:text-slate-400">Ask for book recommendations by theme or mood.</p>
      </div>
      <button id="themeBtn" class="rounded-xl px-3 py-2 text-sm bg-slate-200 dark:bg-slate-800 hover:bg-slate-300 dark:hover:bg-slate-700 transition">
        <span id="themeLabel">Dark</span> mode
      </button>
    </header>

    <!-- Card -->
    <main class="bg-white/80 dark:bg-slate-900/60 backdrop-blur-sm shadow-xl rounded-2xl p-4">
      <!-- Messages -->
      <div id="chat" class="nice-scroll h-[55vh] overflow-y-auto space-y-3 pr-1">
        <!-- initial tip -->
        <div class="flex items-start gap-3">
          <div class="shrink-0 rounded-full bg-indigo-600 text-white w-8 h-8 grid place-items-center font-semibold">A</div>
          <div class="bg-slate-100 dark:bg-slate-800 rounded-2xl px-4 py-3 max-w-[75%]">
            Hi! Tell me what you’re into, and I’ll pick one great book and explain why.
          </div>
        </div>
      </div>

      <!-- Samples -->
      <div class="mt-4 flex flex-wrap gap-2">
        <button class="chip" data-q="Recommend me a book about freedom and social control.">Freedom & control</button>
        <button class="chip" data-q="I love whimsical adventures and found family. What should I read?">Whimsical adventure</button>
        <button class="chip" data-q="Suggest a classic romance with sharp social commentary.">Classic romance</button>
        <button class="chip" data-q="I want a gritty post-apocalyptic story with heart.">Post-apocalyptic</button>
      </div>

      <!-- Input -->
      <div class="mt-3 flex items-end gap-3">
        <textarea id="q" rows="3" placeholder="e.g., Recommend me a book about freedom and social control."
          class="flex-1 resize-none rounded-2xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>

        <div class="flex flex-col gap-2 min-w-[112px]">
          <button id="send" class="rounded-xl px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50">Send</button>
          <div class="flex gap-2">
            <button id="mic" class="flex-1 rounded-xl px-3 py-2 bg-slate-200 dark:bg-slate-800 hover:bg-slate-300 dark:hover:bg-slate-700">Speak</button>
            <button id="speak" class="flex-1 rounded-xl px-3 py-2 bg-slate-200 dark:bg-slate-800 hover:bg-slate-300 dark:hover:bg-slate-700" disabled>Read</button>
          </div>
        </div>
      </div>

      <!-- Loading -->
      <div id="loading" class="hidden mt-3 flex items-center gap-2 text-slate-500">
        <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4A4 4 0 008 12H4z"/></svg>
        Thinking…
      </div>
    </main>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden">
      <div class="bg-red-500 text-white rounded-xl px-4 py-2 shadow-lg">Error</div>
    </div>
  </div>

  <script>
    // ---------- Config ----------
    const API = "http://127.0.0.1:8000";

    // ---------- DOM ----------
    const chat = document.getElementById('chat');
    const q = document.getElementById('q');
    const sendBtn = document.getElementById('send');
    const micBtn = document.getElementById('mic');
    const speakBtn = document.getElementById('speak');
    const loading = document.getElementById('loading');
    const toast = document.getElementById('toast');
    const themeBtn = document.getElementById('themeBtn');
    const themeLabel = document.getElementById('themeLabel');

    // ---------- Theme ----------
    const applyTheme = (t) => {
      document.documentElement.classList.toggle('dark', t === 'dark');
      themeLabel.textContent = t === 'dark' ? 'Light' : 'Dark';
      localStorage.setItem('theme', t);
    };
    const saved = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    applyTheme(saved);
    themeBtn.onclick = () => applyTheme(document.documentElement.classList.contains('dark') ? 'light' : 'dark');

    // ---------- Helpers ----------
    function showToast(msg) {
      toast.querySelector('div').textContent = msg;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 2200);
    }
    function bubble(role, html) {
      const me = role === 'user';
      const avatar = me
        ? '<div class="shrink-0 rounded-full bg-sky-600 text-white w-8 h-8 grid place-items-center font-semibold">U</div>'
        : '<div class="shrink-0 rounded-full bg-indigo-600 text-white w-8 h-8 grid place-items-center font-semibold">A</div>';
      const wrap = document.createElement('div');
      wrap.className = `flex items-start gap-3 ${me ? 'justify-end' : ''}`;
      wrap.innerHTML = me
        ? `<div class="bg-sky-600 text-white rounded-2xl px-4 py-3 max-w-[75%]">${html}</div>${avatar}`
        : `${avatar}<div class="bg-slate-100 dark:bg-slate-800 rounded-2xl px-4 py-3 max-w-[75%]">${html}</div>`;
      chat.appendChild(wrap);
      chat.scrollTop = chat.scrollHeight;
    }
    function setLoading(on) {
      loading.classList.toggle('hidden', !on);
      sendBtn.disabled = on;
      micBtn.disabled = on;
    }
    function stripHTML(s){const d=document.createElement('div'); d.innerHTML=s; return d.textContent || d.innerText || '';}

    let lastReply = "";

    // ---------- API calls ----------
    async function askServer(text){
      const r = await fetch(API + '/ask', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({query:text})
      });
      if(!r.ok){
        const t = await r.text();
        throw new Error(t || r.statusText);
      }
      return await r.json();
    }
    async function tts(text, lang='en'){
      const r = await fetch(API + '/tts', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({text, lang})
      });
      if(!r.ok) throw new Error(await r.text());
      const blob = await r.blob();
      new Audio(URL.createObjectURL(blob)).play();
    }

    // ---------- UI actions ----------
    async function send(){
      const text = q.value.trim();
      if(!text) return;
      q.value = '';
      bubble('user', text);
      try{
        setLoading(true);
        const data = await askServer(text);
        let reply = data.message || '';
        if (data.recommended_title){
            const badge = data.difficulty
                ? `<span class="ml-2 text-xs px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-200">${data.difficulty}</span>`
                : '';
            const by = data.author ? ` <span class="opacity-70">by ${data.author}</span>` : '';
            reply = `I recommend <b>${data.recommended_title}</b>${by} ${badge}<br><br>${data.detailed_summary}`;

            if (Array.isArray(data.alternatives) && data.alternatives.length){
                const alt = data.alternatives
                .map(a => `${a.title}${a.author?` — ${a.author}`:''}${a.difficulty?` [${a.difficulty}]`:''}`)
                .join(', ');
                reply += `<br><small>Alternatives: ${alt}</small>`;
            }
        }

        lastReply = stripHTML(reply);
        bubble('assistant', reply);
        speakBtn.disabled = false;
      }catch(e){
        showToast('Request failed');
        bubble('assistant', 'Sorry, something went wrong.');
        console.error(e);
      }finally{
        setLoading(false);
      }
    }

    sendBtn.onclick = send;
    q.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && !e.shiftKey){
        e.preventDefault();
        send();
      }
    });

    // sample chips
    document.querySelectorAll('.chip').forEach(ch => {
      ch.className = "chip rounded-full px-3 py-1.5 text-sm bg-slate-200 dark:bg-slate-800 hover:bg-slate-300 dark:hover:bg-slate-700";
      ch.addEventListener('click', () => { q.value = ch.dataset.q; q.focus(); });
    });

    // STT (en-US)
    micBtn.onclick = () => {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR){ showToast("SpeechRecognition unsupported"); return; }
      const rec = new SR();
      rec.lang = 'en-US';
      rec.interimResults = false; rec.maxAlternatives = 1;
      rec.onresult = e => { q.value = e.results[0][0].transcript; q.focus(); };
      rec.start();
    };

    // TTS (English)
    speakBtn.onclick = () => {
      if(!lastReply) return;
      tts(lastReply, 'en').catch(()=>showToast('TTS failed'));
    };
  </script>
</body>
</html>
